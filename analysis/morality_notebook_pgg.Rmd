---
title: "Morality in the time of cognitive famine - Public Goods Game"
author: Jonas Kristoffer Lindel√∏v
date: December, 2018

always_allow_html: yes

output:
  github_document:
    toc: true

---
<!--
# TO DO
* Number of trials per subject as a criterion?
-->

# About
This is part of the analysis that accompanies the paper "Morality in the time of cognitive famine" by Panos, Jonas, Michaela, and others. You are now looking at the analysis of **experiment 1 and 2** using the Public Goods Game to study prosociality.


# Setting up
Load appropriate stuff:
```{r setup, results=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(lme4)
#library(kableExtra)

source('misc/functions utility.R')
source('misc/functions inference.R')  # Contains LRT and LRT_binom
```

You could redo the preprocessing of the original data if you wanted to. It saves the data.frames which are loaded in the sections below.
```{r, eval=FALSE}
source('preprocess PGG.R')
```


# Load data
... and remove two subjects who did not follow instructions (noted by the research assistant)
```{r load data}
# Load the data.frame (not in csv because the matrix columns would be lost)
D_pgg = readRDS('data/pgg.Rda')
D_pgg = subset(D_pgg, condition=='experiment')  # Remove practice, etc.
D_pgg = select(D_pgg, -encode, -equationCorrect, -equationScores, -equationRTs, -recallAns, -equationAnss)  # Tidyr doesn't like these matrix columns and we won't be using them
D_pgg = droplevels(D_pgg)
D = D_pgg  # For convenience
```

# Descriptives
```{r exp12 descriptives}
D_id = D[!duplicated(D$id), ]

# Per-group descriptives for paper
D_id %>%
  group_by(exp) %>%
  summarise(
    n=n(),
    age_years = sprintf('%.1f (%.1f)', mean(age), sd(age)),
    males = sprintf('%i (%.1f %%)', sum(gender=='male'), 100*sum(gender=='male')/n())
  ) #%>%
  # kable() %>% 
  # kable_styling(bootstrap_options = "striped", full_width = F)

# Supplementary table: stratified by level and stimType descriptives
x = D_id %>%  # Per-person
  group_by(stimType, level) %>%
  summarise(
    n=n(),
    males = sprintf('%i (%.1f %%)', sum(gender=='male'), 100*sum(gender=='male')/n()),
    age_years = sprintf('%.1f (%.1f)', mean(age), sd(age))
  )

y = D %>%  # All trials
  group_by(stimType, level) %>%
  summarise(
    arithmetic = sprintf('%.1f%%', mean(equationCorrectness)*100),
    recall = sprintf('%.1f%%', mean(recallProportion)*100)
  )

bind_cols(x, y[,3:4])# %>%
  # kable() %>% 
  # kable_styling(bootstrap_options = "striped", full_width = F)
```

# Concurrent load: Figure 2
```{r figure2, fig.height=5, fig.width=4}
# Fit a simple mixed model to show the results while subtracting individual differences
fit_full = lmer(pggInvest ~ span*stimType + (1|id), D)

# Add the fits to the data
x = ranef(fit_full)  # random effects for each subject
D$pggInvestOffset = mapvalues2(D$id, from=rownames(x$id), to=x$id$`(Intercept)`)  # map it unto data
df_tmp = subset(D, span==1 & level=='1-7')
y_offset = mean(df_tmp$pggInvest - df_tmp$pggInvestOffset, na.rm=T)
D$pggInvestZeroCenter = D$pggInvest - D$pggInvestOffset - y_offset

# Plot the figure
figure2 = ggplot(D, aes(x=span, y=pggInvestZeroCenter, color=level)) + 
  stat_summary(fun.data='mean_cl_boot', position=position_dodge(0.5), size=0.7) +
  stat_summary(fun.y=mean, geom="line", position=position_dodge(0.5), lwd=1.3) +
  #facet_grid(~stimType) +
  labs(title='WM load and cooperation', y='Relative Public Goods Game Investment', x='Complex Span') + 
  scale_x_continuous(breaks=1:7) + scale_y_continuous(breaks=seq(-100, 100, 2))

figure2 = style_my_plot(figure2)

# Save it
ggsave('figures/Figure 2 - PGG and CS span.png', figure2, width=6, height=6, units='cm', dpi=300, scale=1.7)

# Show it 
figure2
```

Supplementary figure:
```{r}
figureS2 = ggplot(D, aes(x=span, y=pggInvest, color=level)) + 
  stat_summary(fun.data='mean_cl_boot', position=position_dodge(0.5), size=0.3) +
  stat_summary(fun.y=mean, geom="line", position=position_dodge(0.5)) +
  facet_grid(~stimType) +
  labs(title='WM load and cooperation', y='Public Goods Game Investment', x='Complex Span') + 
  scale_x_continuous(breaks=1:7) + scale_y_continuous(breaks=seq(-100, 100, 2))

figureS2 = style_my_plot(figureS2)
figureS2

ggsave('figures/Figure S2 - PGG and CS span.png', figureS2, width=9, height=6, units='cm', dpi=300, scale=1.7)
```



# Concurrent load: inference
Main test:
```{r pgg load}
LRT(D, 
    pggInvest ~ span + stimType + time_hours + (span|id), 
    pggInvest ~    1 + stimType + time_hours + (span|id))

# Bayesian version (takes a looooooong time to run!)
# Needs well-considered priors
# library(brms)
# full = brm(pggInvest ~ span + (1 + span|id) + (1|stimType), D, chains=5, cores=5, iter=650, warmup=150)
# null = brm(pggInvest ~ 1 + (1 + span|id) + (1|stimType), D, chains=5, cores=5, iter=650, warmup=150)
# bayes_factor(full, null)
```

Effect of CS stimulus type:
```{r}
LRT(D, 
    pggInvest ~ span * stimType + time_hours + (span|id), 
    pggInvest ~ span + stimType + time_hours + (span|id))
```

Effect of difficulty level:
```{r}
LRT(D, 
    pggInvest ~ span * level + (1+span|id),
    pggInvest ~ span + level + (1+span|id))
```


# Depletion: Figure 3
```{r figure3}
# Get subject random effects. Intercept t=0, but keep level-specific offsets
fit = lmer(pggInvest ~ time_secs + level + stimType + (1|id), D)
x = ranef(fit)

# map it unto data
D$pggInvestOffset = mapvalues2(D$id, from=rownames(x$id), to=x$id$`(Intercept)`)

# Plot linearly with data
figure3 = ggplot(D, aes(x=time_secs/60, y=pggInvest - pggInvestOffset, color=level, fill=level)) +  # plot data with subject-specific offsets
  stat_smooth(method='glm') +  # Make it linear
  stat_summary_bin(fun.y=mean, geom='point', binwidth=2, size=2) +
  facet_grid(stimType~level) + 
  
  # Styling
  labs(title='Depletion and cooperation', y='Public Goods Game Investment', x='Minutes elapsed') + 
  scale_x_continuous(breaks=seq(0, 20, 5)) + coord_cartesian(xlim=c(0, 20), ylim=c(35, 60)) + scale_y_continuous(breaks=seq(-100, 100, 5))

figure3 = style_my_plot(figure3)
figure3

ggsave('figures/Figure 3 - PGG and CS depletion.png', figure3, width=8, height=3.8, units='cm', dpi=300, scale=2)
```


# Depletion on PGG investment: Inference
Main analysis. Notice that span is not nested in the random effect for `id` because it may be confounded by the between-subject variable `level`.
```{r pgg objective depletion}
LRT(D, pggInvest ~ level * time_secs + stimType + (1|id),
       pggInvest ~ level + time_secs + stimType + (1|id))
```
Without easy-letters:
```{r}
LRT(subset(D, !(level == '1-3' & stimType=='Letters')), 
    pggInvest ~ level * time_secs + stimType + (1|id),
    pggInvest ~ level + time_secs + stimType + (1|id))

```


Only easy-letters
```{r}
LRT(subset(D, (level == '1-3' & stimType=='Letters')), 
    pggInvest ~ time_secs + (1|id),
    pggInvest ~         1 + (1|id))
```


# Supplementary stuff
See the notebook for the dots task for more supplementary analyses.